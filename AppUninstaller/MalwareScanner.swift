import Foundation
import AppKit

// MARK: - 恶意软件类型
enum MalwareType: String, CaseIterable {
    case adware = "广告软件"
    case pup = "潜在有害程序"        // Potentially Unwanted Program
    case browserHijacker = "浏览器劫持"
    case trojan = "木马"
    case suspiciousLaunchAgent = "可疑启动项"
    
    var englishName: String {
        switch self {
        case .adware: return "Adware"
        case .pup: return "PUP"
        case .browserHijacker: return "Browser Hijacker"
        case .trojan: return "Trojan"
        case .suspiciousLaunchAgent: return "Suspicious Launch Agent"
        }
    }
    
    var riskLevel: RiskLevel {
        switch self {
        case .trojan: return .high
        case .browserHijacker, .adware: return .medium
        case .pup, .suspiciousLaunchAgent: return .low
        }
    }
}

enum RiskLevel: String {
    case high = "高"
    case medium = "中"
    case low = "低"
    
    var englishName: String {
        switch self {
        case .high: return "High"
        case .medium: return "Medium"
        case .low: return "Low"
        }
    }
    
    var color: String {
        switch self {
        case .high: return "red"
        case .medium: return "orange"
        case .low: return "yellow"
        }
    }
}

// MARK: - 恶意软件特征
struct MalwareSignature {
    let name: String
    let type: MalwareType
    let paths: [String]              // 可能存在的路径
    let bundleIdentifiers: [String]  // Bundle ID
    let launchAgentPatterns: [String] // LaunchAgent 文件名模式
}

// MARK: - 检测到的威胁
struct DetectedThreat: Identifiable {
    let id = UUID()
    let name: String
    let type: MalwareType
    let path: URL
    let size: Int64
    var isSelected: Bool = true
    
    var formattedSize: String {
        ByteCountFormatter.string(fromByteCount: size, countStyle: .file)
    }
    
    var icon: NSImage? {
        NSWorkspace.shared.icon(forFile: path.path)
    }
}

// MARK: - 恶意软件扫描器
class MalwareScanner: ObservableObject {
    @Published var threats: [DetectedThreat] = []
    @Published var isScanning = false
    @Published var scanProgress: Double = 0
    @Published var currentScanPath: String = ""
    @Published var scanComplete = false
    
    private let fileManager = FileManager.default
    
    // MARK: - 内置恶意软件特征库
    private let signatures: [MalwareSignature] = [
        // 广告软件
        MalwareSignature(
            name: "MacKeeper",
            type: .adware,
            paths: [
                "/Applications/MacKeeper.app",
                "~/Library/Application Support/MacKeeper",
                "~/Library/Caches/com.mackeeper.MacKeeper"
            ],
            bundleIdentifiers: ["com.mackeeper.MacKeeper"],
            launchAgentPatterns: ["com.mackeeper"]
        ),
        MalwareSignature(
            name: "Advanced Mac Cleaner",
            type: .adware,
            paths: [
                "/Applications/Advanced Mac Cleaner.app",
                "~/Library/Application Support/Advanced Mac Cleaner"
            ],
            bundleIdentifiers: ["com.pcvark.Advanced-Mac-Cleaner"],
            launchAgentPatterns: ["com.pcvark"]
        ),
        MalwareSignature(
            name: "Mac Auto Fixer",
            type: .adware,
            paths: [
                "/Applications/Mac Auto Fixer.app",
                "~/Library/Application Support/Mac Auto Fixer"
            ],
            bundleIdentifiers: ["com.techyutils.macautofixer"],
            launchAgentPatterns: ["com.techyutils"]
        ),
        MalwareSignature(
            name: "Mac Cleanup Pro",
            type: .pup,
            paths: [
                "/Applications/Mac Cleanup Pro.app",
                "~/Library/Application Support/Mac Cleanup Pro"
            ],
            bundleIdentifiers: ["com.nektony.MacCleanupPro"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Mac Adware Remover",
            type: .pup,
            paths: [
                "/Applications/Mac Adware Remover.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        
        // 浏览器劫持
        MalwareSignature(
            name: "Genieo",
            type: .browserHijacker,
            paths: [
                "/Applications/Genieo.app",
                "~/Library/Application Support/Genieo",
                "/Library/Frameworks/GenieoExtra.framework",
                "/private/etc/launchd.conf"
            ],
            bundleIdentifiers: ["com.genieo.application"],
            launchAgentPatterns: ["com.genieo", "com.genieoinnovation"]
        ),
        MalwareSignature(
            name: "Conduit",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Conduit",
                "~/Library/Internet Plug-Ins/ConduitNPAPIPlugin.plugin"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.conduit"]
        ),
        MalwareSignature(
            name: "Safe Finder",
            type: .browserHijacker,
            paths: [
                "/Applications/Safe Finder.app",
                "~/Library/Application Support/Safe Finder"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.safefinder"]
        ),
        MalwareSignature(
            name: "Search Baron",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/SearchBaron"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.searchbaron"]
        ),
        
        // 木马/恶意软件
        MalwareSignature(
            name: "OSX.Shlayer",
            type: .trojan,
            paths: [
                "~/Library/Application Support/.system",
                "/tmp/.mount_*"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "OSX.Pirrit",
            type: .trojan,
            paths: [
                "~/Library/Application Support/com.Pirrit",
                "/Library/Application Support/Pirrit"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.pirrit"]
        ),
        
        // 更多 PUP
        MalwareSignature(
            name: "ZipCloud",
            type: .pup,
            paths: [
                "/Applications/ZipCloud.app",
                "~/Library/Application Support/ZipCloud"
            ],
            bundleIdentifiers: ["com.zipcloud"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Driver Tonic",
            type: .pup,
            paths: [
                "/Applications/Driver Tonic.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        
        // ===== 新增：主流广告软件 =====
        MalwareSignature(
            name: "Mac Mechanic",
            type: .adware,
            paths: [
                "/Applications/Mac Mechanic.app",
                "~/Library/Application Support/Mac Mechanic"
            ],
            bundleIdentifiers: ["com.macmechanic.app"],
            launchAgentPatterns: ["com.macmechanic"]
        ),
        MalwareSignature(
            name: "Mac Tonic",
            type: .adware,
            paths: [
                "/Applications/Mac Tonic.app",
                "~/Library/Application Support/Mac Tonic"
            ],
            bundleIdentifiers: ["com.enigmasoftwaregroup.mactonic"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Mac SpeedUp Pro",
            type: .adware,
            paths: [
                "/Applications/Mac SpeedUp Pro.app",
                "~/Library/Application Support/Mac SpeedUp Pro"
            ],
            bundleIdentifiers: ["com.macspeedup.app"],
            launchAgentPatterns: ["com.macspeedup"]
        ),
        MalwareSignature(
            name: "Any Search Manager",
            type: .adware,
            paths: [
                "~/Library/Application Support/Any Search Manager",
                "~/Library/LaunchAgents/com.anysearch.agent.plist"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.anysearch"]
        ),
        MalwareSignature(
            name: "MySearchDial",
            type: .adware,
            paths: [
                "~/Library/Application Support/mysearchdial",
                "~/Library/Internet Plug-Ins/MySearchDialPlugin.plugin"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.mysearchdial"]
        ),
        MalwareSignature(
            name: "Advanced PC Cleanup",
            type: .adware,
            paths: [
                "/Applications/Advanced PC Cleanup.app",
                "~/Library/Application Support/Advanced PC Cleanup"
            ],
            bundleIdentifiers: ["com.systweak.advancedpccleanup"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "YeaDesktop",
            type: .adware,
            paths: [
                "~/Library/Application Support/YeaDesktop"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.yeadesktop"]
        ),
        MalwareSignature(
            name: "Softonic",
            type: .pup,
            paths: [
                "~/Library/Application Support/Softonic"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.softonic"]
        ),
        MalwareSignature(
            name: "InstallCore",
            type: .pup,
            paths: [
                "~/Library/Application Support/InstallCore"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.installcore"]
        ),
        
        // ===== 新增：浏览器劫持程序 =====
        MalwareSignature(
            name: "Search Marquis",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/SearchMarquis",
                "/Library/Application Support/SearchMarquis"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["searchmarquis", "search.marquis"]
        ),
        MalwareSignature(
            name: "Bing Redirect",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Bing Redirect"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["bingredir"]
        ),
        MalwareSignature(
            name: "Yahoo Redirect",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Yahoo Redirect"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Trovi Search",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Trovi",
                "~/Library/Internet Plug-Ins/TroviPlugin.plugin"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.trovi"]
        ),
        MalwareSignature(
            name: "MyWay Search",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/MyWay"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["myway"]
        ),
        MalwareSignature(
            name: "Searchmine",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Searchmine",
                "/Library/Application Support/Searchmine"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["searchmine"]
        ),
        MalwareSignature(
            name: "Chumsearch",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Chumsearch"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["chumsearch"]
        ),
        
        // ===== 新增：挖矿木马 =====
        MalwareSignature(
            name: "OSX.CoinMiner",
            type: .trojan,
            paths: [
                "~/Library/Application Support/.miner",
                "/tmp/.miner",
                "~/Library/LaunchAgents/com.miner.agent.plist"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["miner", "coinminer", "xmrig"]
        ),
        MalwareSignature(
            name: "OSX.CreativeUpdate",
            type: .trojan,
            paths: [
                "~/Library/Application Support/CreativeUpdate",
                "/Library/Application Support/com.CreativeUpdate"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["creativeupdate"]
        ),
        MalwareSignature(
            name: "OSX.CoinTicker",
            type: .trojan,
            paths: [
                "/Applications/CoinTicker.app",
                "~/Library/Application Support/CoinTicker"
            ],
            bundleIdentifiers: ["com.cointicker"],
            launchAgentPatterns: []
        ),
        
        // ===== 新增：后门木马 =====
        MalwareSignature(
            name: "OSX.Backdoor",
            type: .trojan,
            paths: [
                "~/Library/Application Support/.backdoor",
                "/tmp/.bd"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["backdoor"]
        ),
        MalwareSignature(
            name: "OSX.FakeAV",
            type: .trojan,
            paths: [
                "/Applications/Mac Defender.app",
                "/Applications/Mac Security.app",
                "/Applications/Mac Protector.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "OSX.Dok",
            type: .trojan,
            paths: [
                "/Users/Shared/.local",
                "/Users/Shared/AppStore.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        
        // ===== 新增：更多 PUP =====
        MalwareSignature(
            name: "SearchAwesome",
            type: .pup,
            paths: [
                "~/Library/Application Support/SearchAwesome"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["searchawesome"]
        ),
        MalwareSignature(
            name: "Cleanup My Mac",
            type: .pup,
            paths: [
                "/Applications/Cleanup My Mac.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Advanced File Optimizer",
            type: .pup,
            paths: [
                "/Applications/Advanced File Optimizer.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Mac Optimizer Pro",
            type: .pup,
            paths: [
                "/Applications/Mac Optimizer Pro.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "macOS Security Alert",
            type: .pup,
            paths: [
                "/Applications/macOS Security Alert.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "UtilityParze",
            type: .pup,
            paths: [
                "~/Library/Application Support/UtilityParze"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["utilityparze"]
        ),
        MalwareSignature(
            name: "FileSendSuite",
            type: .pup,
            paths: [
                "~/Library/Application Support/FileSendSuite"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
    ]
    
    // MARK: - 扫描目录
    private let scanDirectories: [String] = [
        "/Applications",
        "~/Applications",
        "~/Library/Application Support",
        "~/Library/LaunchAgents",
        "/Library/LaunchAgents",
        "/Library/LaunchDaemons",
        "~/Library/Internet Plug-Ins",
        "/Library/Internet Plug-Ins",
        "~/Library/Caches",
        "/Library/Frameworks"
    ]
    
    // MARK: - 扫描方法
    func scan() async {
        await MainActor.run {
            isScanning = true
            scanProgress = 0
            threats = []
            scanComplete = false
            currentScanPath = ""
        }
        
        var detectedThreats: [DetectedThreat] = []
        let totalSteps = Double(signatures.count + scanDirectories.count)
        var currentStep = 0.0
        
        // 1. 检查已知恶意软件特征
        for signature in signatures {
            currentStep += 1
            let step = currentStep
            await MainActor.run { [step] in
                scanProgress = step / totalSteps
                currentScanPath = signature.name
            }
            
            for pathPattern in signature.paths {
                let expandedPath = NSString(string: pathPattern).expandingTildeInPath
                let url = URL(fileURLWithPath: expandedPath)
                
                if fileManager.fileExists(atPath: expandedPath) {
                    let size = calculateSize(at: url)
                    let threat = DetectedThreat(
                        name: signature.name,
                        type: signature.type,
                        path: url,
                        size: size
                    )
                    detectedThreats.append(threat)
                    break // 找到一个路径就够了
                }
            }
            
            // 检查 LaunchAgents
            for pattern in signature.launchAgentPatterns {
                let launchAgentDirs = [
                    NSString(string: "~/Library/LaunchAgents").expandingTildeInPath,
                    "/Library/LaunchAgents",
                    "/Library/LaunchDaemons"
                ]
                
                for dir in launchAgentDirs {
                    if let contents = try? fileManager.contentsOfDirectory(atPath: dir) {
                        for file in contents {
                            if file.lowercased().contains(pattern.lowercased()) {
                                let filePath = URL(fileURLWithPath: dir).appendingPathComponent(file)
                                let size = calculateSize(at: filePath)
                                let threat = DetectedThreat(
                                    name: "\(signature.name) (启动项)",
                                    type: .suspiciousLaunchAgent,
                                    path: filePath,
                                    size: size
                                )
                                detectedThreats.append(threat)
                            }
                        }
                    }
                }
            }
        }
        
        // 2. 扫描可疑未签名启动项
        await scanSuspiciousLaunchAgents(into: &detectedThreats, currentStep: &currentStep, totalSteps: totalSteps)
        
        // 去重
        var uniqueThreats: [DetectedThreat] = []
        var seenPaths: Set<String> = []
        for threat in detectedThreats {
            if !seenPaths.contains(threat.path.path) {
                uniqueThreats.append(threat)
                seenPaths.insert(threat.path.path)
            }
        }
        
        await MainActor.run { [uniqueThreats] in
            self.threats = uniqueThreats
            self.isScanning = false
            self.scanProgress = 1.0
            self.scanComplete = true
            self.currentScanPath = ""
        }
    }
    
    // MARK: - 扫描可疑启动项
    private func scanSuspiciousLaunchAgents(into threats: inout [DetectedThreat], currentStep: inout Double, totalSteps: Double) async {
        let launchAgentDirs = [
            NSString(string: "~/Library/LaunchAgents").expandingTildeInPath,
            "/Library/LaunchAgents"
        ]
        
        for dir in launchAgentDirs {
            currentStep += 1
            let step = currentStep
            await MainActor.run { [step] in
                scanProgress = step / totalSteps
                currentScanPath = dir
            }
            
            guard let contents = try? fileManager.contentsOfDirectory(atPath: dir) else { continue }
            
            for file in contents {
                // 跳过 Apple 官方的启动项
                if file.hasPrefix("com.apple.") { continue }
                
                let filePath = URL(fileURLWithPath: dir).appendingPathComponent(file)
                
                // 检查是否是 plist 文件
                guard file.hasSuffix(".plist") else { continue }
                
                // 读取 plist 检查可疑内容
                if let plistData = try? Data(contentsOf: filePath),
                   let plist = try? PropertyListSerialization.propertyList(from: plistData, format: nil) as? [String: Any] {
                    
                    // 检查 Program 或 ProgramArguments
                    var programPath: String?
                    if let program = plist["Program"] as? String {
                        programPath = program
                    } else if let args = plist["ProgramArguments"] as? [String], let first = args.first {
                        programPath = first
                    }
                    
                    if let path = programPath {
                        // 检查程序是否存在
                        if !fileManager.fileExists(atPath: path) {
                            // 指向不存在的程序，可能是残留
                            let size = calculateSize(at: filePath)
                            let threat = DetectedThreat(
                                name: file.replacingOccurrences(of: ".plist", with: ""),
                                type: .suspiciousLaunchAgent,
                                path: filePath,
                                size: size
                            )
                            threats.append(threat)
                        }
                    }
                }
            }
        }
    }
    
    // MARK: - 删除威胁
    func removeThreats() async -> (success: Int, failed: Int) {
        var successCount = 0
        var failedCount = 0
        
        for threat in threats where threat.isSelected {
            do {
                try fileManager.removeItem(at: threat.path)
                successCount += 1
            } catch {
                print("Failed to remove \(threat.path): \(error)")
                failedCount += 1
            }
        }
        
        // 刷新列表
        await scan()
        
        return (successCount, failedCount)
    }
    
    // MARK: - 计算大小
    private func calculateSize(at url: URL) -> Int64 {
        var totalSize: Int64 = 0
        var isDirectory: ObjCBool = false
        
        if fileManager.fileExists(atPath: url.path, isDirectory: &isDirectory) {
            if isDirectory.boolValue {
                if let enumerator = fileManager.enumerator(at: url, includingPropertiesForKeys: [.fileSizeKey]) {
                    while let fileURL = enumerator.nextObject() as? URL {
                        if let size = try? fileURL.resourceValues(forKeys: [.fileSizeKey]).fileSize {
                            totalSize += Int64(size)
                        }
                    }
                }
            } else {
                if let attrs = try? fileManager.attributesOfItem(atPath: url.path),
                   let size = attrs[.size] as? Int64 {
                    totalSize = size
                }
            }
        }
        return totalSize
    }
    
    // MARK: - 统计
    var selectedCount: Int {
        threats.filter { $0.isSelected }.count
    }
    
    var totalSelectedSize: Int64 {
        threats.filter { $0.isSelected }.reduce(0) { $0 + $1.size }
    }
}
