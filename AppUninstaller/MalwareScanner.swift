import Foundation
import AppKit

// MARK: - 恶意软件类型
enum MalwareType: String, CaseIterable {
    case adware = "广告软件"
    case pup = "潜在有害程序"        // Potentially Unwanted Program
    case browserHijacker = "浏览器劫持"
    case trojan = "木马"
    case suspiciousLaunchAgent = "可疑启动项"
    
    var englishName: String {
        switch self {
        case .adware: return "Adware"
        case .pup: return "PUP"
        case .browserHijacker: return "Browser Hijacker"
        case .trojan: return "Trojan"
        case .suspiciousLaunchAgent: return "Suspicious Launch Agent"
        }
    }
    
    var riskLevel: RiskLevel {
        switch self {
        case .trojan: return .high
        case .browserHijacker, .adware: return .medium
        case .pup, .suspiciousLaunchAgent: return .low
        }
    }
}

enum RiskLevel: String {
    case high = "高"
    case medium = "中"
    case low = "低"
    
    var englishName: String {
        switch self {
        case .high: return "High"
        case .medium: return "Medium"
        case .low: return "Low"
        }
    }
    
    var color: String {
        switch self {
        case .high: return "red"
        case .medium: return "orange"
        case .low: return "yellow"
        }
    }
}

// MARK: - 恶意软件特征
struct MalwareSignature {
    let name: String
    let type: MalwareType
    let paths: [String]              // 可能存在的路径
    let bundleIdentifiers: [String]  // Bundle ID
    let launchAgentPatterns: [String] // LaunchAgent 文件名模式
}

// MARK: - 检测到的威胁
struct DetectedThreat: Identifiable {
    let id = UUID()
    let name: String
    let type: MalwareType
    let path: URL
    let size: Int64
    var isSelected: Bool = true
    
    var formattedSize: String {
        ByteCountFormatter.string(fromByteCount: size, countStyle: .file)
    }
    
    var icon: NSImage? {
        NSWorkspace.shared.icon(forFile: path.path)
    }
}

// MARK: - 恶意软件扫描器
class MalwareScanner: ObservableObject {
    @Published var threats: [DetectedThreat] = []
    @Published var isScanning = false
    @Published var scanProgress: Double = 0
    @Published var currentScanPath: String = ""
    @Published var scanComplete = false
    @Published var processedCount: Int = 0
    @Published var scanDuration: Double = 0
    private var startTime: Date?
    
    private let fileManager = FileManager.default
    
    // MARK: - 内置恶意软件特征库
    private let signatures: [MalwareSignature] = [
        // 广告软件
        MalwareSignature(
            name: "MacKeeper",
            type: .adware,
            paths: [
                "/Applications/MacKeeper.app",
                "~/Library/Application Support/MacKeeper",
                "~/Library/Caches/com.mackeeper.MacKeeper"
            ],
            bundleIdentifiers: ["com.mackeeper.MacKeeper"],
            launchAgentPatterns: ["com.mackeeper"]
        ),
        MalwareSignature(
            name: "Advanced Mac Cleaner",
            type: .adware,
            paths: [
                "/Applications/Advanced Mac Cleaner.app",
                "~/Library/Application Support/Advanced Mac Cleaner"
            ],
            bundleIdentifiers: ["com.pcvark.Advanced-Mac-Cleaner"],
            launchAgentPatterns: ["com.pcvark"]
        ),
        MalwareSignature(
            name: "Mac Auto Fixer",
            type: .adware,
            paths: [
                "/Applications/Mac Auto Fixer.app",
                "~/Library/Application Support/Mac Auto Fixer"
            ],
            bundleIdentifiers: ["com.techyutils.macautofixer"],
            launchAgentPatterns: ["com.techyutils"]
        ),
        MalwareSignature(
            name: "Mac Cleanup Pro",
            type: .pup,
            paths: [
                "/Applications/Mac Cleanup Pro.app",
                "~/Library/Application Support/Mac Cleanup Pro"
            ],
            bundleIdentifiers: ["com.nektony.MacCleanupPro"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Mac Adware Remover",
            type: .pup,
            paths: [
                "/Applications/Mac Adware Remover.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        
        // 浏览器劫持
        MalwareSignature(
            name: "Genieo",
            type: .browserHijacker,
            paths: [
                "/Applications/Genieo.app",
                "~/Library/Application Support/Genieo",
                "/Library/Frameworks/GenieoExtra.framework",
                "/private/etc/launchd.conf"
            ],
            bundleIdentifiers: ["com.genieo.application"],
            launchAgentPatterns: ["com.genieo", "com.genieoinnovation"]
        ),
        MalwareSignature(
            name: "Conduit",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Conduit",
                "~/Library/Internet Plug-Ins/ConduitNPAPIPlugin.plugin"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.conduit"]
        ),
        MalwareSignature(
            name: "Safe Finder",
            type: .browserHijacker,
            paths: [
                "/Applications/Safe Finder.app",
                "~/Library/Application Support/Safe Finder"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.safefinder"]
        ),
        MalwareSignature(
            name: "Search Baron",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/SearchBaron"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.searchbaron"]
        ),
        
        // 木马/恶意软件
        MalwareSignature(
            name: "OSX.Shlayer",
            type: .trojan,
            paths: [
                "~/Library/Application Support/.system",
                "/tmp/.mount_*"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "OSX.Pirrit",
            type: .trojan,
            paths: [
                "~/Library/Application Support/com.Pirrit",
                "/Library/Application Support/Pirrit"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.pirrit"]
        ),
        
        // 更多 PUP
        MalwareSignature(
            name: "ZipCloud",
            type: .pup,
            paths: [
                "/Applications/ZipCloud.app",
                "~/Library/Application Support/ZipCloud"
            ],
            bundleIdentifiers: ["com.zipcloud"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Driver Tonic",
            type: .pup,
            paths: [
                "/Applications/Driver Tonic.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        
        // ===== 新增：主流广告软件 =====
        MalwareSignature(
            name: "Mac Mechanic",
            type: .adware,
            paths: [
                "/Applications/Mac Mechanic.app",
                "~/Library/Application Support/Mac Mechanic"
            ],
            bundleIdentifiers: ["com.macmechanic.app"],
            launchAgentPatterns: ["com.macmechanic"]
        ),
        MalwareSignature(
            name: "Mac Tonic",
            type: .adware,
            paths: [
                "/Applications/Mac Tonic.app",
                "~/Library/Application Support/Mac Tonic"
            ],
            bundleIdentifiers: ["com.enigmasoftwaregroup.mactonic"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Mac SpeedUp Pro",
            type: .adware,
            paths: [
                "/Applications/Mac SpeedUp Pro.app",
                "~/Library/Application Support/Mac SpeedUp Pro"
            ],
            bundleIdentifiers: ["com.macspeedup.app"],
            launchAgentPatterns: ["com.macspeedup"]
        ),
        MalwareSignature(
            name: "Any Search Manager",
            type: .adware,
            paths: [
                "~/Library/Application Support/Any Search Manager",
                "~/Library/LaunchAgents/com.anysearch.agent.plist"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.anysearch"]
        ),
        MalwareSignature(
            name: "MySearchDial",
            type: .adware,
            paths: [
                "~/Library/Application Support/mysearchdial",
                "~/Library/Internet Plug-Ins/MySearchDialPlugin.plugin"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.mysearchdial"]
        ),
        MalwareSignature(
            name: "Advanced PC Cleanup",
            type: .adware,
            paths: [
                "/Applications/Advanced PC Cleanup.app",
                "~/Library/Application Support/Advanced PC Cleanup"
            ],
            bundleIdentifiers: ["com.systweak.advancedpccleanup"],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "YeaDesktop",
            type: .adware,
            paths: [
                "~/Library/Application Support/YeaDesktop"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.yeadesktop"]
        ),
        MalwareSignature(
            name: "Softonic",
            type: .pup,
            paths: [
                "~/Library/Application Support/Softonic"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.softonic"]
        ),
        MalwareSignature(
            name: "InstallCore",
            type: .pup,
            paths: [
                "~/Library/Application Support/InstallCore"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.installcore"]
        ),
        
        // ===== 新增：浏览器劫持程序 =====
        MalwareSignature(
            name: "Search Marquis",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/SearchMarquis",
                "/Library/Application Support/SearchMarquis"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["searchmarquis", "search.marquis"]
        ),
        MalwareSignature(
            name: "Bing Redirect",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Bing Redirect"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["bingredir"]
        ),
        MalwareSignature(
            name: "Yahoo Redirect",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Yahoo Redirect"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Trovi Search",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Trovi",
                "~/Library/Internet Plug-Ins/TroviPlugin.plugin"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["com.trovi"]
        ),
        MalwareSignature(
            name: "MyWay Search",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/MyWay"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["myway"]
        ),
        MalwareSignature(
            name: "Searchmine",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Searchmine",
                "/Library/Application Support/Searchmine"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["searchmine"]
        ),
        MalwareSignature(
            name: "Chumsearch",
            type: .browserHijacker,
            paths: [
                "~/Library/Application Support/Chumsearch"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["chumsearch"]
        ),
        
        // ===== 新增：挖矿木马 =====
        MalwareSignature(
            name: "OSX.CoinMiner",
            type: .trojan,
            paths: [
                "~/Library/Application Support/.miner",
                "/tmp/.miner",
                "~/Library/LaunchAgents/com.miner.agent.plist"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["miner", "coinminer", "xmrig"]
        ),
        MalwareSignature(
            name: "OSX.CreativeUpdate",
            type: .trojan,
            paths: [
                "~/Library/Application Support/CreativeUpdate",
                "/Library/Application Support/com.CreativeUpdate"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["creativeupdate"]
        ),
        MalwareSignature(
            name: "OSX.CoinTicker",
            type: .trojan,
            paths: [
                "/Applications/CoinTicker.app",
                "~/Library/Application Support/CoinTicker"
            ],
            bundleIdentifiers: ["com.cointicker"],
            launchAgentPatterns: []
        ),
        
        // ===== 新增：后门木马 =====
        MalwareSignature(
            name: "OSX.Backdoor",
            type: .trojan,
            paths: [
                "~/Library/Application Support/.backdoor",
                "/tmp/.bd"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["backdoor"]
        ),
        MalwareSignature(
            name: "OSX.FakeAV",
            type: .trojan,
            paths: [
                "/Applications/Mac Defender.app",
                "/Applications/Mac Security.app",
                "/Applications/Mac Protector.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "OSX.Dok",
            type: .trojan,
            paths: [
                "/Users/Shared/.local",
                "/Users/Shared/AppStore.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        
        // ===== 新增：更多 PUP =====
        MalwareSignature(
            name: "SearchAwesome",
            type: .pup,
            paths: [
                "~/Library/Application Support/SearchAwesome"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["searchawesome"]
        ),
        MalwareSignature(
            name: "Cleanup My Mac",
            type: .pup,
            paths: [
                "/Applications/Cleanup My Mac.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Advanced File Optimizer",
            type: .pup,
            paths: [
                "/Applications/Advanced File Optimizer.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "Mac Optimizer Pro",
            type: .pup,
            paths: [
                "/Applications/Mac Optimizer Pro.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "macOS Security Alert",
            type: .pup,
            paths: [
                "/Applications/macOS Security Alert.app"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
        MalwareSignature(
            name: "UtilityParze",
            type: .pup,
            paths: [
                "~/Library/Application Support/UtilityParze"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: ["utilityparze"]
        ),
        MalwareSignature(
            name: "FileSendSuite",
            type: .pup,
            paths: [
                "~/Library/Application Support/FileSendSuite"
            ],
            bundleIdentifiers: [],
            launchAgentPatterns: []
        ),
    ]
    
    // MARK: - 扫描目录 (系统关键位置)
    private let scanDirectories: [String] = [
        "/Applications",
        "~/Applications",
        "~/Library/Application Support",
        "~/Library/LaunchAgents",
        "/Library/LaunchAgents",
        "/Library/LaunchDaemons",
        "~/Library/Internet Plug-Ins",
        "/Library/Internet Plug-Ins",
        "~/Library/Caches",
        "/Library/Frameworks",
        "/usr/local/bin" // Common place for command line tools/malware
    ]
    
    // MARK: - 扫描方法
    func scan() async {
        await MainActor.run {
            isScanning = true
            scanProgress = 0
            threats = []
            scanComplete = false
            currentScanPath = ""
            processedCount = 0
            scanDuration = 0
            startTime = Date()
        }
        
        var detectedThreats: [DetectedThreat] = []
        var scannedCount = 0
        
        // 1. 快速扫描已知特征 (Signatures)
        let signatureSteps = Double(signatures.count)
        var currentStep = 0.0
        
        for signature in signatures {
            currentStep += 1
            if currentStep.truncatingRemainder(dividingBy: 5) == 0 {
                // 每5个特征更新一次UI，避免过于频繁
                let progress = (currentStep / signatureSteps) * 0.3 // 前30%进度用于特征扫描
                await MainActor.run {
                    self.scanProgress = progress
                    self.currentScanPath = "Checking signatures: \(signature.name)"
                }
            }
            
            // Paths check
            for pathPattern in signature.paths {
                let expandedPath = NSString(string: pathPattern).expandingTildeInPath
                let url = URL(fileURLWithPath: expandedPath)
                if fileManager.fileExists(atPath: expandedPath) {
                   addThreat(to: &detectedThreats, signature: signature, url: url)
                   break
                }
            }
            
            // LaunchAgent check
            if !signature.launchAgentPatterns.isEmpty {
                 checkLaunchAgents(for: signature, patterns: signature.launchAgentPatterns, into: &detectedThreats)
            }
        }
        
        // 2. 深度启发式扫描 (Deep Heuristic Scan)
        // 扫描关键目录下的所有文件
        let deepScanWeight = 0.7 // 后70%进度用于深度扫描
        let dirsToScan = scanDirectories.map { NSString(string: $0).expandingTildeInPath }
        let totalDirs = Double(dirsToScan.count)
        
        for (index, dirPath) in dirsToScan.enumerated() {
            await MainActor.run {
                self.currentScanPath = dirPath
                self.scanProgress = 0.3 + (Double(index) / totalDirs) * deepScanWeight
            }
            
            guard fileManager.fileExists(atPath: dirPath) else { continue }
            
            let url = URL(fileURLWithPath: dirPath)
            // 使用 enumerator 进行递归遍历
            if let enumerator = fileManager.enumerator(at: url, includingPropertiesForKeys: [.isRegularFileKey, .fileSizeKey, .nameKey], options: [.skipsHiddenFiles, .skipsPackageDescendants]) {
                
                for case let fileURL as URL in enumerator {
                    scannedCount += 1
                    
                    // 每扫描 100 个文件更新一次计数和路径（避免主线程卡顿）
                    if scannedCount % 100 == 0 {
                        await MainActor.run {
                            self.processedCount = scannedCount
                            self.currentScanPath = fileURL.path
                        }
                        // 给 UI 循环一点喘息时间，哪怕是微秒级
                        try? await Task.sleep(nanoseconds: 100_000)
                    }
                    
                    // --- 启发式检测逻辑 ---
                    
                    let filename = fileURL.lastPathComponent.lowercased()
                    
                    // A. 关键词检测 (Adware keywords)
                    let keywords = ["mackeeper", "zeobit", "macbooster", "tuneupmymac", "advancedmaccleaner", "macautofixer"]
                    for keyword in keywords {
                        if filename.contains(keyword) {
                            // 排除我们自己的应用 (MacOptimizer / Mac优化大师)
                            if !filename.contains("optimizer") && !filename.contains("优化大师") {
                                addGenericThreat(to: &detectedThreats, name: "Generic Adware (\(keyword))", type: .adware, url: fileURL)
                            }
                        }
                    }
                    
                    // B. 可疑的隐藏文件 (Starting with .) in Application Support
                    // enumerator options skips hidden, but we might want to check them if we removed that option.
                    // If we want hidden file check, we should remove .skipsHiddenFiles.
                    // For now, let's keep it safe and fast.
                    
                    // C. 检查 LaunchAgents 中的未签名/可疑 plist
                    if fileURL.path.contains("/LaunchAgents") || fileURL.path.contains("/LaunchDaemons") {
                        if filename.hasSuffix(".plist") {
                            checkSuspiciousPlist(at: fileURL, into: &detectedThreats)
                        }
                    }
                }
            }
        }
        
        // 去重
        let uniqueThreats = Array(NSOrderedSet(array: detectedThreats)) as? [DetectedThreat] ?? []
        
        await MainActor.run {
            self.threats = uniqueThreats
            self.isScanning = false
            self.scanProgress = 1.0
            self.scanComplete = true
            self.currentScanPath = ""
            self.processedCount = scannedCount // Ensure final count is shown
            if let start = self.startTime {
                self.scanDuration = Date().timeIntervalSince(start)
            }
        }
    }
    
    // Helper to add threat
    private func addThreat(to threats: inout [DetectedThreat], signature: MalwareSignature, url: URL) {
        let size = calculateSize(at: url)
        let threat = DetectedThreat(name: signature.name, type: signature.type, path: url, size: size)
        threats.append(threat)
    }
    
    private func addGenericThreat(to threats: inout [DetectedThreat], name: String, type: MalwareType, url: URL) {
        let size = calculateSize(at: url)
        let threat = DetectedThreat(name: name, type: type, path: url, size: size)
        threats.append(threat)
    }
    
    private func checkLaunchAgents(for signature: MalwareSignature, patterns: [String], into threats: inout [DetectedThreat]) {
        let launchAgentDirs = [
             NSString(string: "~/Library/LaunchAgents").expandingTildeInPath,
             "/Library/LaunchAgents",
             "/Library/LaunchDaemons"
        ]
        
        for dir in launchAgentDirs {
            guard let contents = try? fileManager.contentsOfDirectory(atPath: dir) else { continue }
            for file in contents {
                for pattern in patterns {
                    if file.lowercased().contains(pattern.lowercased()) {
                         let url = URL(fileURLWithPath: dir).appendingPathComponent(file)
                         addGenericThreat(to: &threats, name: "\(signature.name) (Startup Item)", type: signature.type, url: url)
                    }
                }
            }
        }
    }
    
    private func checkSuspiciousPlist(at url: URL, into threats: inout [DetectedThreat]) {
        // Simple heuristic: if plist points to a file in /tmp or obscure locations
        guard let data = try? Data(contentsOf: url),
              let plist = try? PropertyListSerialization.propertyList(from: data, format: nil) as? [String: Any] else { return }
        
        var programArguments: [String] = []
        if let args = plist["ProgramArguments"] as? [String] {
            programArguments = args
        } else if let program = plist["Program"] as? String {
            programArguments = [program]
        }
        
        if let firstArg = programArguments.first {
             if firstArg.contains("/tmp/") || firstArg.contains("/var/folders/") {
                 addGenericThreat(to: &threats, name: "Suspicious Startup Item", type: .suspiciousLaunchAgent, url: url)
             }
        }
    }
    
    // MARK: - 删除威胁
    func removeThreats() async -> (success: Int, failed: Int) {
        var successCount = 0
        var failedCount = 0
        
        var remainingThreats: [DetectedThreat] = []
        
        for threat in threats {
            if threat.isSelected {
                do {
                    try fileManager.removeItem(at: threat.path)
                    successCount += 1
                } catch {
                    print("Failed to remove \(threat.path): \(error)")
                    failedCount += 1
                    remainingThreats.append(threat) // Keep failed ones
                }
            } else {
                remainingThreats.append(threat) // Keep unselected ones
            }
        }
        
        await MainActor.run {
            self.threats = remainingThreats
            // If all removed, UI will auto-switch to safe view because threats is empty
        }
        
        return (successCount, failedCount)
    }
    
    // MARK: - 计算大小
    private func calculateSize(at url: URL) -> Int64 {
        var totalSize: Int64 = 0
        var isDirectory: ObjCBool = false
        
        if fileManager.fileExists(atPath: url.path, isDirectory: &isDirectory) {
            if isDirectory.boolValue {
                if let enumerator = fileManager.enumerator(at: url, includingPropertiesForKeys: [.fileSizeKey]) {
                    while let fileURL = enumerator.nextObject() as? URL {
                        if let size = try? fileURL.resourceValues(forKeys: [.fileSizeKey]).fileSize {
                            totalSize += Int64(size)
                        }
                    }
                }
            } else {
                if let attrs = try? fileManager.attributesOfItem(atPath: url.path),
                   let size = attrs[.size] as? Int64 {
                    totalSize = size
                }
            }
        }
        return totalSize
    }
    
    // MARK: - 统计
    var selectedCount: Int {
        threats.filter { $0.isSelected }.count
    }
    
    var totalSelectedSize: Int64 {
        threats.filter { $0.isSelected }.reduce(0) { $0 + $1.size }
    }
}
